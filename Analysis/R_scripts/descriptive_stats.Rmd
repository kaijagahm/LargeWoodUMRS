---
title: "descriptive_stats"
author: "Kaija Gahm"
date: "1/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Source libraries and functions
```{r}
source("../R_scripts/libraries.R")
source("../R_scripts/ownfunctions.R")
```

# Load data (combined upper/lower river)
```{r}
load("../data/outputs/sites_upperlower.Rda")
load("../data/outputs/sites_ur.Rda")
load("../data/outputs/sites_lr.Rda")
```

# Data Cleaning
## Remove the river mile column
```{r}
head(sites_upperlower)
sites_upperlower <- sites_upperlower %>% dplyr::select(-river_mile)
```

## Exclude strata: BWC-O and MCB-W
```{r}
sites_upperlower <- sites_upperlower %>% filter(stratum %notin% c("BWC-O", "MCB-W")) %>% droplevels()
```

## Exclude sites NA for snag and/or pool
```{r}
sites_upperlower <- sites_upperlower %>% filter(!is.na(snag), !is.na(pool))
```

# Summaries
## Overall
```{r}
summary_all <- sites_upperlower %>% dplyr::summarize(npoints = n(),
                                              wood = sum(snag == 1),
                                              nowood = sum(snag == 0),
                                              propwood = wood/npoints)
```

## By pool
```{r}
# Summary
summary_pool <- sites_upperlower %>% 
  group_by(pool) %>%
  dplyr::summarize(npoints = n(),
            wood = sum(snag == 1),
            nowood =  sum(snag == 0),
            propwood = wood/npoints)

# Test for significant differences
chisq.test(summary_pool[,c("wood", "nowood")])

# Post-hoc test with Bonferroni correction
pairwise.prop.test(x = summary_pool$wood, n = summary_pool$npoints, 
                   p.adjust.method = "bonferroni")
```

## By year and pool
```{r}
# Summary
summary_yearpool <- sites_upperlower %>% group_by(pool, year) %>%
  dplyr::summarize(npoints = n(),
            wood = sum(snag == 1),
            nowood =  sum(snag == 0),
            propwood = wood/npoints) %>% ungroup()

# Plot
summary_yearpool %>% ggplot(aes(x = year, y = propwood, col = pool, group = pool))+
  geom_line()+
  theme_minimal()
```

## By stratum
```{r}
# Summary
summary_stratum <- sites_upperlower %>% group_by(stratum) %>% 
  dplyr::summarize(npoints = n(),
            wood = sum(snag == 1),
            nowood = sum(snag == 0),
            propwood = wood/npoints)

# Calculate confidence intervals for these proportions
cis <- BinomCI(summary_stratum$wood, n = summary_stratum$npoints, conf.level = 0.95)
summary_stratum <- cbind(summary_stratum, cis[,2:3])
row.names(summary_stratum) <- NULL

# Test for significant differences
chisq.test(summary_stratum[,c("wood", "nowood")])

# Post-hoc test with Bonferroni correction
pairwise.prop.test(x = summary_pool$wood, n = summary_pool$npoints, 
                   p.adjust.method = "bonferroni")

# Plot of proportions and confidence intervals by stratum
summary_stratum %>% ggplot(aes(x = stratum, y = propwood))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = lwr.ci,
                    ymax = upr.ci),
                width = 0,
                size = 1.2)+
  theme_minimal()+
  theme(text = element_text(size = 16))+
  ylab("Proportion of points with wood")+
  xlab("Habitat Stratum")+
  ggtitle("Wood proportion by stratum")

```

## By stratum and pool
```{r}
# Summary
summary_stratumpool <- sites_upperlower %>% group_by(pool, stratum) %>%
  dplyr::summarize(npoints = n(),
            wood = sum(snag == 1),
            nowood = sum(snag == 0),
            propwood = wood/npoints) %>% as.data.frame()

# Test for significant differences
chisq.test(summary_stratumpool[,c("wood", "nowood")])

# Confidence intervals
cis <- BinomCI(summary_stratumpool$wood, n = summary_stratumpool$npoints, conf.level = 0.95) %>% as.data.frame()
summary_stratumpool <- summary_stratumpool %>% mutate(lwr.ci = cis$lwr.ci,
                                                      upr.ci = cis$upr.ci)
row.names(summary_stratumpool) <- NULL

# Plot
summary_stratumpool %>% ggplot(aes(x = stratum, y = propwood, color = pool))+
  geom_point(size = 3,
             position = position_dodge(width = 0.3))+
  geom_errorbar(aes(ymin = lwr.ci, ymax = upr.ci),
                width = 0, size = 1.2, position = position_dodge(width = 0.3))+
  theme_minimal()+
  theme(text = element_text(size = 16))+
  ylab("Proportion of points with wood")+
  xlab("Habitat Stratum")

```

## By pool, year, and stratum
```{r}
# Summary
summary_poolyearstratum <- sites_upperlower %>% 
  group_by(pool, year, stratum) %>% 
  dplyr::summarize(npoints = n(),
            wood = sum(snag == 1),
            nowood = sum(snag == 0),
            propwood = wood/npoints) %>%
  as.data.frame()
head(summary_poolyearstratum)   

# Plot of proportions by stratum and pool
summary_poolyearstratum %>% ggplot(aes(x = year, y = propwood, group = stratum))+
  geom_line(aes(linetype = stratum))+
  ylim(0,1)+
  theme_minimal()+
  xlab("Year")+
  ylab("Proportion of points with wood")+
  facet_wrap(~pool)

# Plot of proportions by stratum and pool, only the two most common strata
summary_poolyearstratum %>% filter(stratum %in% c("MCB-U", "SCB")) %>%
  ggplot(aes(x = year, y = propwood, group = stratum))+
  geom_line(size = .65, aes(linetype = stratum))+
  theme_minimal()+
  xlab("Year")+
  ylab("Proportion of points with wood")+
  facet_wrap(~pool)

#Violin plots of annual variation by stratum and pool 
# All observations, by stratum and pool
summary_poolyearstratum %>% ggplot(aes(x = stratum, y = propwood))+
  geom_violin()+
  geom_boxplot(width = 0.1,
               fill = "black",
               outlier.color = NA)+
  stat_summary(fun.y = median,
               geom = "point",
               fill = "white",
               shape = 21,
               size = 2.5)+
  facet_wrap(~pool)

# Pools, including those with > 9 observations
summary_poolyearstratum %>% filter(npoints > 9) %>%
  ggplot(aes(x = pool, y = propwood))+
  geom_violin()+
  geom_boxplot(width = 0.1,
               fill = "black",
               outlier.color = NA)+
  stat_summary(fun.y = median,
               geom = "point",
               fill = "white",
               shape = 21,
               size = 2.5)

# Stratum and pool, greater than 10 observations
summary_poolyearstratum %>% filter(npoints > 9) %>%
  ggplot(aes(x = stratum, y = propwood))+
  geom_violin()+
  geom_boxplot(width=0.1,
               fill="black",
               outlier.colour=NA)+
  stat_summary(fun.y=median, 
               geom="point",
               fill="white",
               shape=21,
               size=2.5)+
  facet_wrap(~pool)

table(summary_poolyearstratum$stratum)
summary_poolyearstratum %>% filter(pool == "P04", stratum == "BWC-S") %>% 
  ggplot(aes(x = year, y = propwood))+
  geom_point()
```

# Time series
## Set plotting parameters
```{r}
ylims <- c(0,1)
```

## Function for making models
```{r}
makemod <- function(model, x){
  y0 <- (x0 * model$coefficients[[2]]) + model$coefficients[[1]]
  return(y0)
}
```

## Overall
### Examine by pool
```{r}
summary_yearpool %>% ggplot(aes(x = as.numeric(year), y = propwood))+
  geom_point()+
  stat_smooth(method = "loess", col = "red", se = F)+
  facet_wrap(~pool)+
  xlab("Year")+
  ylab("Proportion with LW")
```

### Pool 4
#### All years
```{r}
p4 <- summary_yearpool %>% filter(pool == "P04") %>% dplyr::select(year, propwood) %>% mutate(year = as.numeric(year))
p4 %>% ggplot(aes(x = year, y = propwood))+
  geom_point()

lin.mod <- lm(propwood ~ year, data = p4)
seg.mod <- segmented(lin.mod, data = p4, psi = 1999) # singular
p4$seg_fit <- broken.line(seg.mod)$fit # add fitted values to the data frame.

p4 %>% ggplot(aes(x = year, y = propwood))+
  geom_point()+
  geom_line(aes(y = seg_fit), lwd = 0.3)+
  theme_minimal()+
  xlab("Year")+
  ylab("Proportion with LW")+
  ggtitle("Pool 4") 

plot(y ~ x, # compare this to the above for how they connect the lines... weird that it's different.
     pch = 19, 
     cex = 1.5, 
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 4")
plot(seg.mod, add = T)
```

#### After 1999
```{r}
p4b <- p4 %>% filter(year >= 1999)
x <- p4b$year
y <- p4b$propwood
lin.mod <- lm(y ~ x)
plot(y ~ x, pch = 19,
     cex = 1.5,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 4")
abline(lin.mod)

p4b %>% ggplot(aes(x = year, y = propwood))+
  geom_point()+
  stat_smooth(method = "lm", col = "red")+
  theme_minimal()
```

#### Tests
```{r}
pettitt.test(p4$propwood)  #first 6 points is separate
mk.test(p4$propwood) #monotonic trend? 
```

#### Mean before change
```{r}
plot(propwood ~ year, data = p4,
     pch = 19,
     cex = 1.5,
     ylim = ylims,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 4",
     cex.lab = 1.5,
     cex.axis = 1.25)
abline(v = 1998.5, col = "red", lwd = 3, lty = 2)

lm1 <- lm(propwood ~ year, data = p4[1:6,])
x0 <- 1992.5
y0 <- makemod(lm1, x0)
x1 <- 1998.5
y1 <- makemod(lm1, x1)
         #segments(x0,y0,x1,y1,lty=1,lwd=3,col="darkgrey")
summary(lm1)
mn <- p4[1:6,] %>% pull(propwood) %>% mean()

segments(x0, mn, x1, mn, lwd = 3, lty = 2, col = "darkgrey")
text(1995, 0.25, labels = "mean = 0.487", cex = 1.5) # 2/15/20 THIS IS NO LONGER CORRECT

lm2 <- lm(propwood ~ year, data = p4[7:nrow(p4),])
x0 <- 1998.5
y0 <- makemod(lm2, x0)
x1 <- 2017.5
y1 <- makemod(lm2, x1)
      #segments(x0,y0,x1,y1,lty=1,lwd=3,col="darkgrey")
mn <- p4[7:nrow(p4),] %>% pull(propwood) %>% mean()
segments(x0, mn, x1, mn, lwd = 3, lty = 2, col = "darkgrey")
text(2009, 0.45, labels = "mean = 0.730", cex = 1.5)
points(propwood ~ year, data = p4, pch = 19, cex = 1.75)
mn
summary(lm2)
```

### Pool 8
#### All years
```{r}
p8 <- summary_yearpool %>% filter(pool == "P08") %>% dplyr::select(year, propwood) %>% mutate(year = as.numeric(year))
plot(propwood ~ year, data = p8, pch = 19)
x <- p8$year
y <- p8$propwood
lin.mod <- lm(y ~ x)
seg.mod <- segmented(lin.mod, seg.Z = ~x, psi = 2003)
summary(seg.mod)

plot(y ~ x, pch = 19,
     cex = 1.5,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 8",
     cex.lab = 1.5,
     cex.axis = 1.25)
plot(seg.mod, add = T)
summary(seg.mod)
pettitt.test(p8$propwood) # first 6 points is separate
mk.test(p8$propwood) # monotonic trend? yes, highly significant trend

plot(propwood ~ year, data = p8,
     pch = 19,
     cex = 1.75,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 8",
     cex.lab = 1.5,
     cex.axis = 1.25,
     ylim = ylims)
abline(v = 2003.5, col = "red", lwd = 3, lty = 2)
lm1 <- lm(propwood ~ year, data = p8[1:10,])
x0 <- 1992.5 # starting year
y0 <- makemod(lm1, x0)
x1 <- 2003.5 #
y1 <- makemod(lm1, x1)
segments(x0, y0, x1, y1, lty = 1, lwd = 3, col = "black")
summary(lm1)
mn <- p8[1:10,] %>% pull(propwood) %>% mean()
    # text(1996.5,0.9,labels="*",cex=8,col="black")
text(1999, 0.94, labels = "slope = -0.029", cex = 1.5, col = "black")
text(1999, 0.87, labels = "p = 0.020", cex = 1.5, col = "black")
text(1999, 0.8, bquote(r^2 == 0.525), cex = 1.5)

lm2 <- lm(propwood ~ year, data = p8[11:nrow(p8),])
x0 <- 2003.5
y0 <- makemod(lm2, x0)
x1 <- 2017.5
y1 <- makemod(lm2, x1)
     #segments(x0,y0,x1,y1,lty=1,lwd=3,col="darkgrey")
mn <- p8[11:nrow(p8),] %>% pull(propwood) %>% mean()
segments(x0, mn, x1, mn, col = "darkgrey", lwd = 3, lty = 2)
text(2011, 0.75, labels = "mean = 0.430", cex = 1.5, col = "black")

lm3 <- lin.mod # back to the full dataset
abline(lm3, col = "black", lwd = 1.5)
text(1994, 0.5, labels = "slope = -0.144", cex = 1.25)
text(1994, 0.44, labels = "p < 0.001", cex = 1.25)
text(1994, 0.38, bquote(r^2 == 0.594), cex = 1.25) #labels="r2 = 0.525",cex=1.25)

points(propwood ~ year, data = p8, pch = 19, cex = 1.75)     
```

### Pool 13
#### All years
```{r}
p13 <- summary_yearpool %>% filter(pool == "P13") %>% dplyr::select(year, propwood) %>% mutate(year = as.numeric(year))

plot(propwood ~ year, data = p13, pch = 19)
x <- p13$year
y <- p13$propwood
lin.mod <- lm(y ~ x)
seg.mod <- segmented(lin.mod, seg.Z = ~x, psi = 2005)

plot(y ~ x, pch = 19, 
     cex = 1.5, 
     xlab = "Year", 
     ylab = "Proportion with LW", 
     main="Pool 13")
plot(seg.mod, add = T)
summary(seg.mod)

pettitt.test(p13$propwood) # first 12 points is separate
mk.test(p13$propwood) # monotonic trend?

plot(propwood ~ year, data = p13,
     pch = 19,
     cex = 1.75,
     xlab = "Year", 
     ylab = "Proportion with LW", 
     main="Pool 13",
     cex.lab = 1.5, 
     cex.axis = 1.25,
     ylim = ylims)
abline(v = 2004.5, col = "red", lwd = 3, lty = 2)

lm1 <- lm(propwood ~ year, data = p13[1:12,])
x0 <- 1992.5
y0 <- makemod(lm1, x0)
x1 <- 2004.5
y1 <- makemod(lm1, x1)
   #segments(x0,y0,x1,y1,lty=1,lwd=3,col="darkgrey")
mn <- p13[1:10,] %>% pull(propwood) %>% mean()
segments(x0, mn, x1, mn, lty = 2, lwd = 3, col = "darkgrey")
summary(lm1)
mn
text(1998, 0.55, labels = "mean = 0.758", cex = 1.5)
     
lm2 <- lm(propwood ~ year, data = p13[13:nrow(p13),])
x0 <- 2004.5
y0 <- makemod(lm2, x0)
x1 <- 2017.5
y1 <- makemod(lm2, x1)
     #segments(x0,y0,x1,y1,lty=1,lwd=3,col="darkgrey")
mn <- p13[13:nrow(p13),] %>% pull(propwood) %>% mean()
segments(x0, mn, x1, mn, lty = 2, lwd = 3, col = "darkgrey")
text(2012, 0.45, labels = "mean = 0.666", cex = 1.5)
points(propwood ~ year, data = p13, pch = 19, cex = 1.75)

mn
lm2
```

### Pool 26
#### All years
```{r}
p26 <- summary_yearpool %>% filter(pool == "P26") %>% dplyr::select(year, propwood) %>% mutate(year = as.numeric(year))

plot(propwood ~ year, data = p26, pch = 19)
x <- p26$year
y <- p26$propwood
lin.mod <- lm(y ~ x)
seg.mod <- segmented(lin.mod, seg.Z = ~x, psi = 2000)

plot(y ~ x, pch = 19,
     cex = 1.5,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 26")
plot(seg.mod, add = T)
summary(seg.mod)
summary(lin.mod)
slope(seg.mod)

pettitt.test(p26$propwood) # break in mean? NO
mk.test(p26$propwood) # monotonic trend? NO
(mean1 <- mean(p26$propwood)) #No trends/breaks whatsoever
     
plot(propwood ~ year, data = p26,
     pch = 19,
     cex = 1.75,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 26",
     cex.lab = 1.5,
     cex.axis = 1.25,
     ylim = ylims)
abline(h = mean(p26$propwood), col = "darkgrey", lwd = 2, lty = 2)
points(propwood ~ year, data = p26, pch = 19, cex = 1.75)
text(2015, 0.9, labels = "mean = 0.594", cex = 1.5)   
```








## Aquatic areas by pool
### P4
#### Exploratory
```{r}
p4 <- summary_poolyearstratum %>% filter(pool == "P04") %>% dplyr::select(year, stratum, propwood)

  # exploratory first...
  p4 %>% ggplot(aes(x = as.numeric(year), y = propwood))+
    geom_point()+
    stat_smooth(method = "loess", col = "red")+
    theme_minimal()+
    theme(text = element_text(size = 20))+
    facet_wrap(~stratum)
  
  # examine habitats separately
  p4.bwc <- p4 %>% filter(stratum == "BWC-S")
  pettitt.test(p4.bwc$propwood) # first 6 points is separate [edit 2/15/20: i don't know how to interpret this test, just reproducing the comments as they were before.]
  mk.test(p4.bwc$propwood) # monotonic trend?
  
  p4.mcb <- p4 %>% filter(stratum == "MCB-U")
  pettitt.test(p4.mcb$propwood) # first 6 points is separate 
  mk.test(p4.mcb$propwood) # monotonic trend?

  p4.scb <- p4 %>% filter(stratum == "SCB")
  pettitt.test(p4.scb$propwood) # first 6 points is separate 
  mk.test(p4.scb$propwood) # monotonic trend?
```

#### Plots for export
```{r}
#Plot for export
ah.pch <- c(NA, 3, NA, NA, NA, 19, NA, 1)[as.numeric(p4$stratum)]
plot(propwood ~ year, 
     data = p4, 
     cex = 1.75,
     xlab = "Year",
     ylab = "Proportion with LW",
     main = "Pool 4",
     cex.lab = 1.5,
     cex.axis = 1.25,
     ylim = ylims,
     pch = ah.pch)
abline(v = 1998.5, col = "black", lty = 1, lwd = 1) #MCB - or lwd = 3?
abline(v = 1998.5, col = "grey", lty = 2, lwd = 1) #BWC
abline(v = 2000.5, col = "grey", lty = 1, lwd = 1) # SCB
points(propwood ~ year, data = p4, cex = 1.75, pch = ah.pch) # Kaija 2/15/20: why is this necessary if we already specified the points and point types in the original plot call?
```





